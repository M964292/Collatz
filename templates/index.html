<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тренажёр гипотезы Коллатца</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .game-area, .history-area {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .sequence {
            font-size: 1.2em;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            word-break: break-all;
        }
        @media (max-width: 576px) {
            .container {
                padding: 5px;
            }
            .game-area, .history-area {
                padding: 10px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .sequence {
                font-size: 1em;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <img src="{{ url_for('static', filename='logo-mir.png') }}" alt="Школа МИР" class="img-fluid" style="max-width: 320px; height: auto;">
        </div>
        <h1 class="text-center mb-4">Тренажёр гипотезы Коллатца</h1>
        
        <div class="mb-3 text-center">
            <span id="timer" class="badge bg-info fs-5">00:00</span>
        </div>
        
        <div class="game-area">
            <form onsubmit="event.preventDefault(); startCustomGame();" class="row g-2 mb-3">
                <div class="col-12 col-md-6 d-grid mb-2 mb-md-0">
                    <button type="button" class="btn btn-primary w-100" onclick="startRandomGame()">Случайное число</button>
                </div>
                <div class="col-12 col-md-6 d-flex">
                    <input type="number" id="customNumber" class="form-control me-2" placeholder="Ваше число">
                    <button type="submit" class="btn btn-secondary">Начать</button>
                </div>
            </form>

            <div class="instructions mb-3">
                <h5>Правила:</h5>
                <ol>
                    <li>Если число чётное, разделите его на 2</li>
                    <li>Если число нечётное, умножьте на 3 и прибавьте 1</li>
                    <li>Продолжайте, пока не получите 1</li>
                </ol>
            </div>

            <div id="gameContent" style="display: none;">
                <div class="current-number mb-3">
                    <h4>Текущее число: <span id="currentNumber"></span></h4>
                </div>

                <form onsubmit="event.preventDefault(); checkAnswer();" class="answer-input mb-3 d-flex">
                    <input type="number" id="answer" class="form-control me-2" placeholder="Ваш ответ">
                    <button type="submit" class="btn btn-success">Проверить</button>
                </form>

                <div class="sequence" id="sequence"></div>
                <div class="mt-2 text-end">
                    <button class="btn btn-outline-secondary btn-sm" onclick="showCorrectSequence()">Проверка</button>
                </div>
                <div id="correctSequence" class="alert alert-secondary mt-2 d-none"></div>
            </div>
        </div>

        <div class="history-area">
            <h3 class="h5">История решений</h3>
            <div id="history"></div>
            <div class="mt-2 text-end">
                <button class="btn btn-danger btn-sm" onclick="showResetHistory()">Сбросить историю</button>
            </div>
        </div>
    </div>

    <script>
        let currentNumber = null;
        let sequence = [];
        let timerInterval = null;
        let startTime = null;

        function startTimer() {
            startTime = Date.now();
            updateTimer();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
            const sec = String(elapsed % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${min}:${sec}`;
        }

        function startRandomGame() {
            fetch('/start_random')
                .then(response => response.json())
                .then(data => {
                    currentNumber = data.number;
                    sequence = data.sequence;
                    updateDisplay();
                    startTimer();
                });
        }

        function startCustomGame() {
            const number = document.getElementById('customNumber').value;
            if (!number) {
                alert('Введите число');
                return;
            }
            fetch('/start_custom', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ number: parseInt(number) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                currentNumber = data.number;
                sequence = data.sequence;
                updateDisplay();
                startTimer();
            });
        }

        function checkAnswer() {
            const answer = document.getElementById('answer').value;
            if (!answer) {
                alert('Введите ответ');
                return;
            }

            fetch('/check_answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answer: parseInt(answer) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.correct) {
                    if (data.game_over) {
                        stopTimer();
                        alert(`Поздравляем! Вы решили задачу за ${data.time.toFixed(2)} секунд`);
                        updateHistory();
                    } else {
                        currentNumber = data.next_number;
                        sequence = data.sequence;
                        updateDisplay();
                    }
                } else {
                    alert(`Неверно! Правильный ответ: ${data.expected}`);
                }
                document.getElementById('answer').value = '';
            });
        }

        function updateDisplay() {
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('currentNumber').textContent = currentNumber;
            document.getElementById('sequence').textContent = sequence.join(' → ');
            document.getElementById('correctSequence').classList.add('d-none');
        }

        function updateHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    const historyHtml = data.map(game => `
                        <div class="mb-2">
                            <strong>Начальное число:</strong> ${game.start}<br>
                            <strong>Шагов:</strong> ${game.steps}<br>
                            <strong>Время:</strong> ${game.time.toFixed(2)} сек<br>
                            <strong>Последовательность:</strong> ${game.sequence.join(' → ')}<br>
                            <hr>
                        </div>
                    `).join('');
                    document.getElementById('history').innerHTML = historyHtml;
                });
        }

        function showResetHistory() {
            const password = prompt('Введите пароль администратора для сброса истории:');
            if (!password) return;
            fetch('/reset_history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateHistory();
                    alert('История очищена!');
                } else {
                    alert('Неверный пароль!');
                }
            });
        }

        function showCorrectSequence() {
            if (!currentNumber) {
                alert('Сначала выберите число!');
                return;
            }
            fetch('/get_sequence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ number: currentNumber })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('correctSequence').classList.remove('d-none');
                document.getElementById('correctSequence').textContent = 'Правильная последовательность: ' + data.sequence.join(' → ');
            });
        }

        // Загружаем историю при загрузке страницы
        updateHistory();
    </script>
</body>
</html>
